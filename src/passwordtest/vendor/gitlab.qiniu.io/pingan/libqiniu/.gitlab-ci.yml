image: golang:1.9.0
test:
  before_script:
    - |
      echo 'deb http://mirrors.aliyun.com/debian/ stretch main non-free contrib' > /etc/apt/sources.list
      apt-get update -y
    - 'which ssh-agent || ( apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - echo 'nameserver 114.114.114.114' >> /etc/resolv.conf
    - echo 'nameserver 8.8.8.8' >> /etc/resolv.conf
  script:
    - |
      apt-get install -y golang-glide
    - mkdir -p /go/src/gitlab.qiniu.io/pingan/
    - cp -r . /go/src/gitlab.qiniu.io/pingan/libqiniu
    - |
      cd /go/src/gitlab.qiniu.io/pingan/libqiniu
      glide install -v
      go build ./...
      go test -v ./...
